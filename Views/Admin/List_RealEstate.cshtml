@model IEnumerable<Website_BDS.Models.Product>

@{
    ViewBag.Title = "Quản lý Bất động sản";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}
<link rel="stylesheet" href="@Url.Content("~/Font-end/CSS/CSS_Admin/Style_List-RealEstate.css")" />

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

<body>
    <div class="header">
        <h2>Quản lý bất động sản <span style="font-size:14px; color:#666; font-weight:normal">(Tổng số: @Model.Count() tin)</span></h2>
        <div class="actions">
            <a href="@Url.Action("Create", "Admin")" class="btn-add">+ Thêm BĐS mới</a>
        </div>
    </div>

    @using (Html.BeginForm("List_RealEstate", "Admin", FormMethod.Get))
    {
        <div class="filters">
            <input type="text" name="searchString" placeholder="Tìm kiếm theo tên hoặc địa chỉ..." value="@Request["searchString"]" />

            <select name="type" onchange="this.form.submit()">
                <option value="">Tất cả loại</option>
                <option value="Căn hộ" @(Request["type"] == "Căn hộ" ? "selected" : "")>Căn hộ</option>
                <option value="Biệt thự" @(Request["type"] == "Biệt thự" ? "selected" : "")>Biệt thự</option>
                <option value="Nhà phố" @(Request["type"] == "Nhà phố" ? "selected" : "")>Nhà phố</option>
                <option value="Đất nền" @(Request["type"] == "Đất nền" ? "selected" : "")>Đất nền</option>
            </select>

            <select name="status" onchange="this.form.submit()">
                <option value="">Tất cả trạng thái</option>
                <option value="Active" @(Request["status"] == "Active" ? "selected" : "")>Còn trống</option>
                <option value="Sold" @(Request["status"] == "Sold" ? "selected" : "")>Đã bán</option>
            </select>

            <button type="submit" style="display:none">Lọc</button>
        </div>
    }

    <div class="list">
        @if (Model.Any())
        {
            foreach (var item in Model)
            {
                <div class="card">
                    <div style="position: relative;">
                        @{
                            var imgUrl = item.PropertyImages.FirstOrDefault(x => x.IsPrimary == true)?.ImageUrl ?? Url.Content("~/Font-end/asset/icon/Home-default.jpg");
                        }
                        <img src="@imgUrl" alt="@item.Title" style="width:100%; height:180px; object-fit:cover; border-radius: 8px 8px 0 0;" />

                        @if (item.Status == "Active")
                        {
                            <div class="status" style="background:#e6f4ea; color:#1e8e3e;">Còn trống</div>
                        }
                        else
                        {
                            <div class="status" style="background:#fce8e6; color:#c5221f;">Đã bán</div>
                        }
                    </div>

                    <div class="card-body">
                        <div class="title">@item.Title</div>
                        <div class="location">📍 @item.District, @item.City</div>

                        <div class="info">
                            <div><i class="fa-solid fa-bed"></i> @item.Bedrooms</div>
                            <div><i class="fa-solid fa-bath"></i> @item.Bathrooms</div>
                            <div><i class="fa-solid fa-ruler-combined"></i> @(item.Area)m²</div>
                        </div>

                        <div class="price">
                            @if (item.Price >= 1000000000)
                            {
                                <span>@((item.Price / 1000000000)?.ToString("0.##")) tỷ</span>
                            }
                            else
                            {
                                <span>@((item.Price / 1000000)?.ToString("0.##")) triệu</span>
                            }
                        </div>
                    </div>

                    <div class="card-footer">
                        <a href="@Url.Action("Product_details","Product" ,new { id = item.ProductID })" class="icon" title="Xem"><i class="fa-solid fa-eye"></i></a>

                        <a href="javascript:void(0);"
                           class="icon btn-delete"
                           data-id="@item.ProductID"
                           title="Xóa">
                            <i class="fa-solid fa-trash"></i>
                        </a>
                    </div>
                </div>
            }
        }
        else
        {
            <p style="text-align:center; width:100%; color:#666; margin-top:50px;">Không tìm thấy bất động sản nào phù hợp.</p>
        }
    </div>
</body>



<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<script>
    $(document).ready(function () {
        $('.btn-delete').click(function (e) {
            e.preventDefault(); // Chặn hành động mặc định

            var btn = $(this);
            var id = btn.data('id');

            if (confirm('Bạn có chắc chắn muốn xóa tin này không? Hành động này không thể hoàn tác.')) {
                $.ajax({
                    url: '@Url.Action("Delete", "Product")', // Hoặc "Admin" tùy controller bạn để
                    type: 'POST',
                    data: {
                        id: id,
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function (response) {
                        if (response.success) {
                            // Xóa thành công -> Ẩn dòng đó đi
                            btn.closest('.card').fadeOut(500, function() {
                                $(this).remove();
                            });
                            alert('Đã xóa thành công!');
                        } else {
                            alert('Lỗi: ' + response.message);
                        }
                    },
                    error: function () {
                        alert('Có lỗi xảy ra khi kết nối server.');
                    }
                });
            }
        });
    });
</script>

@Html.AntiForgeryToken()