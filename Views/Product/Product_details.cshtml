@model Website_BDS.Models.ViewModel.ProductDetailViewModel
@{
    Layout = "~/Views/Shared/_LayoutPageHome.cshtml";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chi tiết sản phẩm</title>
    <link rel="stylesheet" href="~/Font-end/asset/base.css" />
    <link rel="stylesheet" href="~/Font-end/css/style-Product-Details.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

    <style>
        /* CSS nhỏ để ô nhập từ khóa đẹp hơn */
        .input-keyword {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
    </style>

    <script>
        function openMap() {
            // --- SỬA LỖI TẠI ĐÂY ---
            // 1. HtmlDecode: Chuyển đổi mã &#224; thành chữ à
            // 2. JavaScriptStringEncode: Đảm bảo chuỗi an toàn trong JS
            var address = '@HttpUtility.JavaScriptStringEncode(System.Web.HttpUtility.HtmlDecode(Model.Product.Address ?? ""))';

            // 3. encodeURIComponent: Mã hóa URL để Google Maps hiểu
            window.open(
                "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(address),
                "_blank"
            );
        }
    </script>
</head>
<body>
    <div class="product-page">
        <div class="product-info">
            <div class="Image-details">
                <img src="./asset/icon/Product_Null.jpg"
                     alt="image-product"
                     height="300"
                     width="300" />
            </div>

            <div class="Infomation-detailt-product">
                <div class="save">
                    <button class="button_small @(ViewBag.IsSaved == true ? "active-yellow" : "")"
                            onclick="ToggleSave(@Model.Product.ProductID, this)">
                        <i class="fa-solid fa-heart"></i> Lưu tin
                    </button>
                </div>
                <div class="listing-overview">
                    <h1>@Model.Product.Title</h1>
                    <h3>Price : <strong>@Model.Product.Price</strong> VNĐ</h3>
                    <h3>Địa chỉ: @(Model.Product.Address?.ToLower())</h3>
                </div>
                <div class="Contact">Thông tin mô tả</div>
                <div class="information-base">
                    <div class="utility">
                        <h1>Thông tin cơ bản</h1>
                        <div>
                            <p><i class="fa-solid fa-shapes"></i> Loại hình bất động sản: @Model.Product.Type</p>
                            <p><i class="fa-solid fa-chart-area"></i> Diện tích: @Model.Product.Area</p>
                        </div>
                        <div>
                            <p><i class="fa-solid fa-bed"></i> Số phòng ngủ: @Model.Product.Bedrooms</p>
                            <p><i class="fa-solid fa-bath"></i> Số phòng vệ sinh: @Model.Product.Bathrooms </p>
                        </div>
                        <div class="action-button">
                            <button class="button_small"><i class="fa-solid fa-heart"></i> Lưu</button>
                            <button class="button_small"><i class="fa-solid fa-share"></i> Chia sẻ</button>
                            <button class="button_small"><i class="fa-solid fa-circle-exclamation"></i> Báo vi phạm</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="user-info">
            <div class="product-user-infomation_details">
                <div class="User">
                    <span id="Avatar-User">
                        <img src="@Url.Content(
                            string.IsNullOrEmpty(Model?.Seller?.Avatar_User)
                                ? "~/Font-end/asset/icon/User-default.jpg"
                                : "~/Content/" + Model.Seller.Avatar_User
                        )" alt="Avatar" style="width:70px; height:70px; border-radius:50%; object-fit:cover;" />
                    </span>
                    <button class="button_small">Xem trang</button>
                </div>

                <div class="contact">
                    <button class="button_small">Liên hệ số điện thoại</button>
                    <button class="button_small">Liên hệ zalo</button>
                </div>
            </div>

            <div class="comment-section">
                <h4>Bình luận</h4>
                <div class="Area-comment">
                    <textarea placeholder="Bình Luận..." class="Comment"></textarea>
                    <button class="button_small">
                        <i class="fa-solid fa-paper-plane"></i>
                        Gửi
                    </button>
                </div>
            </div>

            <div class="mini-map" onclick="openMap()" style="cursor: pointer; margin-top: 20px;">
                <h4 style="margin-bottom: 10px;">Vị trí trên bản đồ:</h4>
                <iframe width="100%"
                        height="250"
                        style="border: 0; pointer-events: none;"
                        loading="lazy"
                        allowfullscreen
                        src="https://maps.google.com/maps?q=@HttpUtility.UrlEncode(Model.Product.Address)&t=&z=15&ie=UTF8&iwloc=&output=embed">
                </iframe>
                <p style="text-align:center; font-size: 12px; color: #666; margin-top: 5px;">(Nhấn vào bản đồ để xem chi tiết)</p>
            </div>
        </div>
    </div>

    

</body>
</html>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<script>
    function ToggleSave(productId, btnElement) {
        $.ajax({
            url: '@Url.Action("ToggleSaveProduct", "Users")',
            type: 'POST',
            data: { productId: productId },
            success: function (response) {
                if (response.success) {
                    if (response.isSaved) {
                        $(btnElement).addClass('active-yellow');
                        alert("Đã lưu tin thành công!");
                    } else {
                        $(btnElement).removeClass('active-yellow');
                        alert("Đã bỏ lưu tin!");
                    }
                } else {
                    alert(response.message);
                }
            },
            error: function (xhr, status, error) {
                console.error("Lỗi:", error);
                alert("Có lỗi kết nối: " + xhr.status + ". Vui lòng kiểm tra Console (F12).");
            }
        });
    }
</script>