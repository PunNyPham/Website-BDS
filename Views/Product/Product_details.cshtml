@model Website_BDS.Models.ViewModel.ProductDetailViewModel

@{
    ViewBag.Title = Model.Product.Title;
    Layout = "~/Views/Shared/_LayoutPageHome.cshtml";
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="~/Font-end/asset/base.css" />
    <link rel="stylesheet" href="~/Font-end/CSS/style-Product-Details.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
</head>
<body>

    <div class="container-details">
        <div class="top-nav">
            <a href="@Url.Action("Index", "Home")" class="back-link">
                <i class="fa-solid fa-chevron-left"></i> Quay lại
            </a>
        </div>

        <div class="gallery-container">
            @{
                var images = Model.Product.PropertyImages?.Take(5).ToList() ?? new List<Website_BDS.Models.PropertyImage>();
                while (images.Count < 5)
                {
                    images.Add(new Website_BDS.Models.PropertyImage { ImageUrl = "~/Font-end/asset/icon/Product_Null.jpg" });
                }
            }

            <div class="gallery-item main-photo">
                <img src="@Url.Content(images[0].ImageUrl)" onerror="this.src='/Font-end/asset/icon/Product_Null.jpg'" />
            </div>

            @for (int i = 1; i < 5; i++)
            {
                <div class="gallery-item sub-photo">
                    <img src="@Url.Content(images[i].ImageUrl)" onerror="this.src='/Font-end/asset/icon/Product_Null.jpg'" />
                    @if (i == 4 && Model.Product.PropertyImages.Count > 5)
                    {
                        <div class="overlay-count">+@(Model.Product.PropertyImages.Count - 5) ảnh</div>
                    }
                </div>
            }
        </div>

        <div class="content-wrapped">

            <div class="main-info">
                <div class="header-info">
                    <h1>@Model.Product.Title</h1>
                    <p class="address"><i class="fa-solid fa-location-dot"></i> @(Model.Product.Address ?? "Đang cập nhật")</p>

                    <div class="action-row">
                        <span class="price-tag">
                            @if (Model.Product.Price >= 1000000000)
                            {
                                @((Model.Product.Price / 1000000000)?.ToString("0.##")) <span>Tỷ</span>
                            }
                            else
                            {
                                @((Model.Product.Price / 1000000)?.ToString("0.##")) <span>Triệu</span>
                            }
                        </span>
                        <div class="action-buttons">
                            <button class="btn-icon @(ViewBag.IsSaved == true ? "active-saved" : "")" onclick="ToggleSave(@Model.Product.ProductID, this)">
                                <i class="@(ViewBag.IsSaved == true ? "fa-solid" : "fa-regular") fa-heart"></i>
                            </button>
                            <button class="btn-icon"><i class="fa-solid fa-share-nodes"></i></button>
                        </div>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-box">
                        <i class="fa-solid fa-bed"></i>
                        <span>Phòng ngủ</span>
                        <strong>@Model.Product.Bedrooms phòng</strong>
                    </div>
                    <div class="stat-box">
                        <i class="fa-solid fa-bath"></i>
                        <span>Phòng tắm</span>
                        <strong>@Model.Product.Bathrooms phòng</strong>
                    </div>
                    <div class="stat-box">
                        <i class="fa-solid fa-expand"></i>
                        <span>Diện tích</span>
                        <strong>@Model.Product.Area m²</strong>
                    </div>
                    <div class="stat-box">
                        <i class="fa-regular fa-calendar"></i>
                        <span>Năm xây dựng</span>
                        <strong>2023</strong>
                    </div>
                </div>

                <div class="section-box">
                    <h3>Mô tả chi tiết</h3>
                    <div class="desc-content">
                        @Html.Raw(Model.Product.Description?.Replace("\n", "<br>"))
                    </div>
                </div>

                <div class="section-box">
                    <h3>Tiện nghi</h3>
                    <div class="amenities-grid">
                        <span><i class="fa-solid fa-car"></i> Bãi đổ xe</span>
                        <span><i class="fa-solid fa-wifi"></i> Internet</span>
                        <span><i class="fa-solid fa-dumbbell"></i> Phòng gym</span>
                        <span><i class="fa-solid fa-shield-halved"></i> An ninh 24/7</span>
                        <span><i class="fa-solid fa-couch"></i> Nội thất cao cấp</span>
                        <span><i class="fa-solid fa-person-swimming"></i> Hồ bơi</span>
                    </div>
                </div>

                <div class="section-box">
                    <h3>Vị trí</h3>
                    <div class="map-container-figma" onclick="openMap()">
                        <div class="map-placeholder">
                            <i class="fa-solid fa-location-dot map-pin-icon"></i>
                            <span>Bản đồ vị trí</span>
                            <p>@Model.Product.Address</p>
                        </div>
                    </div>

                    <ul class="nearby-locations">
                        <li><span class="dot"></span> 5 phút đến trường Quốc tế Anh</li>
                        <li><span class="dot"></span> 10 phút đến Metro Thảo Điền</li>
                        <li><span class="dot"></span> 15 phút đến trung tâm Quận 1</li>
                    </ul>
                </div>
            </div>

            <div class="sidebar">
                <div class="contact-card">
                    <div class="card-title-consult">Liên hệ tư vấn</div>

                    <div class="agent-profile">
                        <img src="@Url.Content(string.IsNullOrEmpty(Model.Seller?.Avatar_User) ? "~/Font-end/asset/icon/User-default.jpg" : "~/Content/" + Model.Seller.Avatar_User)"
                             alt="Avatar" onerror="this.src='/Font-end/asset/icon/User-default.jpg'" />
                        <div class="agent-info">
                            <h4>@(Model.Seller?.FullName ?? "Chuyên viên tư vấn")</h4>
                            <span>Chuyên viên tư vấn</span>
                        </div>
                    </div>

                    <form class="contact-form">
                        <input type="text" placeholder="Họ và tên *" class="form-input" />
                        <input type="text" placeholder="Số điện thoại *" class="form-input" />
                        <input type="email" placeholder="Email" class="form-input" />
                        <input type="text" placeholder="dd/mm/yyyy" onfocus="(this.type='date')" class="form-input" />
                        <textarea placeholder="Tôi quan tâm đến bất động sản này..." class="form-input" rows="4"></textarea>

                        <button type="button" class="btn-send-request">Gửi yêu cầu tư vấn</button>
                    </form>

                    <div class="contact-methods">
                        <div class="method-row">
                            <i class="fa-solid fa-phone"></i>
                            <span>@(Model.Seller.PhoneNumber ?? "0901 234 567")</span>
                        </div>
                        <div class="method-row">
                            <i class="fa-regular fa-envelope"></i>
                            <span>contact@batdongsan.vn</span>
                        </div>
                    </div>
                </div>

                <div class="quick-info-box">
                    <h3>Thông tin nhanh</h3>
                    <div class="info-row"><span>Mã BĐS:</span> <strong>VN-@Model.Product.ProductID</strong></div>
                    <div class="info-row"><span>Loại hình:</span> <strong>@Model.Product.Type</strong></div>
                    <div class="info-row"><span>Pháp lý:</span> <strong>Sổ hồng</strong></div>
                    <div class="info-row"><span>Hướng:</span> <strong>Đông Nam</strong></div>
                    <div class="info-row"><span>Số tầng:</span> <strong>3 tầng</strong></div>
                    <div class="info-row"><span>Ngày đăng:</span> <strong>@Model.Product.CreatedAt</strong></div>
                </div>
            </div>
        </div>

        <div class="related-section">
            <h3>Bất động sản tương tự</h3>
            <div class="related-grid">
                @if (Model.listproduct != null)
                {
                    foreach (var item in Model.listproduct.Take(4))
                    {
                        <div class="mini-card">
                            <div class="card-img-top">
                                <img src="@Url.Content(item.PropertyImages.FirstOrDefault()?.ImageUrl ?? "~/Font-end/asset/icon/Product_Null.jpg")" onerror="this.src='/Font-end/asset/icon/Product_Null.jpg'" />
                            </div>
                            <div class="mini-card-body">
                                <span class="price">@string.Format("{0:N0}", item.Price) VNĐ</span>
                                <h4>@item.Title</h4>
                                <p><i class="fa-solid fa-location-dot"></i> @item.District</p>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>

    <script>
        /* --- Thay thế hàm cũ bằng hàm này --- */
        function openMap() {
            // Lấy địa chỉ từ Model
            var address = '@HttpUtility.JavaScriptStringEncode(System.Web.HttpUtility.HtmlDecode(Model.Product.Address ?? ""))';

            // Link chuẩn của Google Maps
            var mapUrl = "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(address);

            // Mở tab mới
            window.open(mapUrl, "_blank");
        }

        function ToggleSave(productId, btnElement) {
            $.ajax({
                url: '@Url.Action("ToggleSaveProduct", "Users")',
                type: 'POST',
                data: { productId: productId },
                success: function (response) {
                    if (response.success) {
                        if (response.isSaved) {
                            $(btnElement).addClass('active-saved');
                            $(btnElement).find('i').removeClass('fa-regular').addClass('fa-solid');
                        } else {
                            $(btnElement).removeClass('active-saved');
                            $(btnElement).find('i').removeClass('fa-solid').addClass('fa-regular');
                        }
                    } else {
                        alert(response.message);
                        if(response.message.includes("đăng nhập")) {
                            window.location.href = '@Url.Action("Login", "Account")';
                        }
                    }
                },
                error: function () {
                    alert("Có lỗi xảy ra khi kết nối server.");
                }
            });
        }
    </script>
</body>
</html>