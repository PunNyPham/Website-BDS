@model Website_BDS.Models.ViewModel.UserProfileViewModel
@{
    string userName = Model?.User?.FullName ?? "Người dùng";
    ViewBag.Title = "Trang cá nhân - " + userName;
    Layout = "~/Views/Shared/_LayoutPageUser.cshtml";
}

<link rel="stylesheet" href="@Url.Content("~/Font-end/CSS/edit-page_user.css")" />

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<div class="post-list-container">

    <h3 class="section-title">Quản lý bài đăng</h3>

    <div class="listing-summary">
        <div class="listing-status-item">
            <span class="listing-label">Tất cả</span>
            <span class="listing-count">@Model.Products.Count()</span>
        </div>
        <div class="listing-status-item"><span class="listing-label">Tin chưa duyệt</span><span class="listing-count">@Model.Products.Count(x => x.Status == "Pending")</span></div>
        <div class="listing-status-item"><span class="listing-label">Tin hết hạn</span><span class="listing-count">0</span></div>
    </div>

    @if (Model.Products != null && Model.Products.Any())
    {
        foreach (var item in Model.Products)
        {
            <div class="post-item-card">
                <div class="post-info">
                    <div class="post-thumb">
                        @{
                            var imgUrl = item.PropertyImages.FirstOrDefault()?.ImageUrl ?? "~/Font-end/asset/icon/Product_Null.jpg";
                        }
                        <img src="@Url.Content(imgUrl)" onerror="this.src='@Url.Content("~/Font-end/asset/icon/Product_Null.jpg")'" />

                        @if (item.Rank == 1)
                        {<span class="badge-vip silver">VIP Bạc</span> }
                        else if (item.Rank == 2)
                        { <span class="badge-vip gold">VIP Vàng</span> }
                        else if (item.Rank == 3)
                        { <span class="badge-vip diamond">VIP Kim Cương</span>}
                    </div>
                    <div class="post-text">
                        <h4>@item.Title</h4>
                        <p>@String.Format("{0:N0} VNĐ", item.Price) - @item.Address</p>
                        <p style="font-size:12px; color:#888; margin-top:4px;">
                            Trạng thái:
                            @if (item.Status == "Active")
                            {<span style="color:green">Đang hiển thị</span> }
                            else
                            { <span style="color:orange">Chờ duyệt</span>}
                        </p>
                    </div>
                </div>

                <i class="fa-solid fa-gear action-gear" data-id="@item.ProductID"></i>

                <div class="action-menu" id="menu-@item.ProductID">
                    <a href="@Url.Action("Product_details", "Product", new { id = item.ProductID })">Xem chi tiết</a>
                    <a href="@Url.Action("Edit", "RealEstate", new { id = item.ProductID })">Sửa tin</a>

                    <a href="javascript:void(0)" onclick="openVipModal(@item.ProductID)" style="color:#d35400; font-weight:bold;">
                        <i class="fa-solid fa-crown" style="margin-right:5px;"></i> Mua dịch vụ
                    </a>

                    <a href="javascript:void(0)" class="btn-delete" data-id="@item.ProductID">Xóa tin</a>
                </div>
            </div>
        }
    }
    else
    {
        <p style="text-align:center; padding:30px; color:#999;">Bạn chưa đăng tin nào.</p>
    }
</div>

<div id="vipModal" class="modal-overlay" style="display:none;">
    <div class="vip-modal-box">
        <h3>Nâng cấp tin VIP</h3>
        <input type="hidden" id="vipProductId" />

        <div class="vip-options">
            <label class="vip-option silver">
                <input type="radio" name="vipPackage" value="1">
                <div><strong>VIP Bạc</strong><p>50.000đ / 7 ngày</p></div>
            </label>
            <label class="vip-option gold">
                <input type="radio" name="vipPackage" value="2">
                <div><strong>VIP Vàng</strong> (Hot)<p>100.000đ / 7 ngày</p></div>
            </label>
            <label class="vip-option diamond">
                <input type="radio" name="vipPackage" value="3">
                <div><strong>VIP Kim Cương</strong><p>200.000đ / 7 ngày</p></div>
            </label>
        </div>

        <div class="modal-actions">
            <button onclick="closeVipModal()" class="btn-cancel">Hủy</button>
            <button onclick="submitBuyVip()" class="btn-confirm">Thanh toán ngay</button>
        </div>
    </div>
</div>

<div id="modal-container"></div>


<script>
    // 1. Toggle Menu Bánh răng
    document.addEventListener("click", function (e) {
        if (e.target.classList.contains("action-gear")) {
            let id = e.target.dataset.id;
            let menu = document.getElementById("menu-" + id);

            // Đóng các menu khác
            document.querySelectorAll(".action-menu").forEach(m => {
                if (m !== menu) m.style.display = "none";
            });

            // Toggle menu hiện tại
            menu.style.display = (menu.style.display === "block") ? "none" : "block";
        } else if (!e.target.closest(".post-item-card")) {
            // Click ra ngoài thì đóng hết
            document.querySelectorAll(".action-menu").forEach(m => m.style.display = "none");
        }
    });

    // 2. Xử lý xóa tin (AJAX)
    $(document).on('click', '.btn-delete', function (e) {
        e.preventDefault();
        var btn = $(this);
        var id = btn.data('id');
        var card = btn.closest('.post-item-card');

        if (confirm('Bạn có chắc chắn muốn xóa tin này không?')) {
            $.ajax({
                url: '/Product/Delete', // Đảm bảo đúng đường dẫn Controller
                type: 'POST',
                data: { id: id },
                success: function (res) {
                    if (res.success) {
                        card.fadeOut(300, function () { $(this).remove(); });
                    } else {
                        alert(res.message);
                    }
                },
                error: function () { alert('Lỗi kết nối server'); }
            });
        }
    });

    // 3. Xử lý Modal VIP
    function openVipModal(id) {
        $('#vipProductId').val(id);
        $('#vipModal').css('display', 'flex');
    }

    function closeVipModal() {
        $('#vipModal').hide();
    }

    function submitBuyVip() {
        var id = $('#vipProductId').val();
        var level = $('input[name="vipPackage"]:checked').val();

        if (!level) { alert("Vui lòng chọn gói VIP!"); return; }

        $.ajax({
            url: '/RealEstate/BuyVip',
            type: 'POST',
            data: { productId: id, vipLevel: level },
            success: function (res) {
                if (res.success) {
                    alert(res.message);
                    location.reload();
                } else {
                    alert(res.message);
                }
            },
            error: function () { alert('Lỗi kết nối server'); }
        });
    }
</script>

<style>
    /* --- Khung thẻ chính --- */
    .post-item-card {
        position: relative; /* Quan trọng để căn chỉnh nút bánh răng và menu */
        background-color: #fff;
        border-radius: 30px; /* Bo góc mềm mại */
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06); /* Đổ bóng nhẹ tạo chiều sâu */
        padding: 30px;
        margin-bottom: 30px; /* Khoảng cách giữa các thẻ */
        border: 1px solid #f0f0f0; /* Viền mờ */
        transition: all 0.2s ease-in-out; /* Hiệu ứng mượt mà */
        height: auto;
    }

        /* Hiệu ứng khi di chuột vào thẻ */
        .post-item-card:hover {
            transform: translateY(-3px); /* Nổi lên nhẹ */
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1); /* Bóng đậm hơn */
            border-color: #e0e0e0;
        }

    /* --- Phần thông tin (Ảnh + Text) --- */
    .post-info {
        display: flex; /* Sắp xếp ảnh và text nằm ngang */
        align-items: center; /* Căn giữa theo chiều dọc */
        gap: 16px; /* Khoảng cách giữa ảnh và text */
    }

    /* --- Phần hình ảnh thumbnail --- */
    .post-thumb {
        flex-shrink: 0; /* Không bị co lại khi màn hình nhỏ */
        width: 110px; /* Chiều rộng cố định */
        height: 85px; /* Chiều cao cố định */
        border-radius: 8px;
        overflow: hidden; /* Ẩn phần ảnh thừa */
        border: 1px solid #eee;
    }

        .post-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Ảnh tự động lấp đầy khung mà không bị méo */
        }

    /* --- Phần nội dung chữ --- */
    .post-text {
        flex-grow: 1; /* Chiếm phần không gian còn lại */
        overflow: hidden; /* Xử lý text dài */
        padding-right: 40px; /* Dành chỗ cho nút bánh răng không đè lên text */
    }

        .post-text h4 {
            margin: 0 0 8px 0;
            font-size: 16px;
            font-weight: 600;
            color: #222;
            /* Tự động cắt text nếu quá dài (1 dòng) */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .post-text p {
            margin: 0;
            font-size: 14px;
            color: #666;
            line-height: 1.5;
            /* Tự động cắt text địa chỉ nếu quá dài (tối đa 2 dòng) */
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

    /* (Tùy chọn) Làm nổi bật giá tiền */
    .price-highlight {
        color: #d32f2f; /* Màu đỏ cho giá */
        font-weight: 700;
        font-size: 15px;
    }

    /* --- Nút bánh răng cài đặt --- */
    .action-gear {
        position: absolute; /* Căn vị trí tuyệt đối so với thẻ cha */
        top: 12px;
        right: 12px;
        font-size: 18px;
        color: #a0a0a0;
        cursor: pointer;
        padding: 8px; /* Tăng vùng bấm cho dễ click */
        border-radius: 50%;
        transition: all 0.2s;
        z-index: 2;
    }

        .action-gear:hover {
            color: #555;
            background-color: #f5f5f5; /* Nền xám nhẹ khi hover */
        }

    /* --- Menu hành động (Ẩn/Hiện) --- */
    .action-menu {
        position: absolute;
        top: 10px; /* Vị trí ngay dưới nút bánh răng */
        right: -150px;
        background-color: #fff;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15); /* Bóng đổ nổi bật */
        border-radius: 8px;
        padding: 8px 0;
        min-width: 140px; /* Chiều rộng tối thiểu */
        z-index: 100; /* Đảm bảo nằm trên các phần tử khác */
        border: 1px solid #eee;
        animation: fadeInMenu 0.2s ease-in-out; /* Hiệu ứng hiện ra */
    }

        /* Link trong menu */
        .action-menu a {
            display: flex;
            align-items: center;
            padding: 10px 16px;
            text-decoration: none;
            color: #444;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s;
        }

            .action-menu a:hover {
                background-color: #f7f9fa;
                color: #007bff; /* Màu xanh khi hover link thường */
            }

            /* Riêng nút Xóa */
            .action-menu a.btn-delete {
                color: #d32f2f; /* Màu đỏ */
                border-top: 1px solid #f0f0f0; /* Đường kẻ ngăn cách nhẹ phía trên nút xóa */
                margin-top: 4px;
                padding-top: 12px;
            }

                .action-menu a.btn-delete:hover {
                    background-color: #fff1f0; /* Nền đỏ nhạt khi hover */
                    color: #c62828;
                }

        /* (Tùy chọn) Mũi tên nhỏ chỉ lên của menu */
        .action-menu::before {
            content: '';
            position: absolute;
            top: 40px;
            right: 20px;
            width: 12px;
            height: 12px;
            background: #fff;
            transform: rotate(45deg);
            border-top: 1px solid #eee;
            border-left: 1px solid #eee;
        }

    /* Hiệu ứng menu hiện ra */
    @@keyframes fadeInMenu {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>